---
import AuthLayout from '@/layouts/AuthLayout.astro';
import LoginForm from '@/components/auth/LoginForm.vue';

const supabase = Astro.locals.supabase;

if (!supabase) {
  throw new Error('Supabase client is unavailable in Astro.locals');
}

const {
  data: { session },
} = await supabase.auth.getSession();

if (session) {
  return Astro.redirect('/');
}

const redirectParam = Astro.url.searchParams.get('redirect') ?? '';
const redirectTarget = redirectParam.startsWith('/') ? redirectParam : null;

const flashMessages = {
  'logout-success': 'Wylogowano pomyślnie. Do zobaczenia!',
  'session-expired': 'Twoja sesja wygasła. Zaloguj się ponownie.',
  'activation-success': 'Email potwierdzony. Zaloguj się, aby kontynuować.',
  'activation-failed': 'Nie udało się potwierdzić adresu email. Spróbuj ponownie.',
  'activation-missing-code': 'Brakuje kodu potwierdzenia. Użyj linku z wiadomości email.',
} as const;

const flashKey = Astro.url.searchParams.get('flash') ?? '';
const flashMessage = flashKey in flashMessages ? flashMessages[flashKey as keyof typeof flashMessages] : null;
---

<AuthLayout
  title="StravaGoals — Logowanie"
  description="Zaloguj się, aby zarządzać celami treningowymi w StravaGoals"
  heading="Zaloguj się"
  subheading="Uzyskaj dostęp do swojego panelu i kontynuuj realizację planu"
>
  <LoginForm
    client:load
    redirect-target={redirectTarget ?? undefined}
    flash-message={flashMessage ?? undefined}
  />

  <div slot="links" class="space-y-2">
    <p class="text-sm text-muted-foreground">
      Nie masz konta?
      <a href="/auth/register" class="font-semibold text-primary">Zarejestruj się</a>
    </p>
    <p class="text-sm text-muted-foreground">
      Zapomniałeś hasła?
      <a href="/auth/recover" class="font-semibold text-primary">Odzyskaj dostęp</a>
    </p>
  </div>
</AuthLayout>

